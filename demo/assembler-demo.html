<html>
    <head>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Assembler in Java - Francis McNamee</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="../css/style.css">
        <link rel="stylesheet" href="../css/lisp-demo.css">
    </head>
    <body>
        <div class="iframe-container" data-iframe-size>
            <h1 class="text-center demo-title">ARM64 Assembler in Java</h1>
            <hr>
            <p class="text-center"><a href="/projects/assembler-writeup.html">Click here to find out how I made this project</a></p>
            <h2>Introduction</h2>
            <p>My assembler ...</p>
		<h2>Example Code</h2>
		<div class="codeBlock">
            <div class="playground">
                <form>
                    <textarea placeholder="Type your code here ..." class="code" rows="17"/>; example assembly code
.global _main, hello
_main:
        mov x1, 10
        mov x2, x1
xyz:
        mov x3, 2000
        mov x4, x3
        mov x5, 50
hello:
        mov x6, 100
        mov x7, 200
abc:
        mov x0, x7     ; exit code
        mov x16, 1     ; syscall number for exit
world:
        svc 0x80       ; do the syscall</textarea>
                    <div class="align-right">
                        <div class="button">
                            <input type="submit" class="run" value="Run code" />
                            <img class="loading" src="../images/loading2.gif">
                        </div>
                    </div>
                </form>
                <div class="macho">
                    
                </div>
            </div>
		</div>
        <p>Thank you for reading about my Assembler implementation, I hope you enjoyed playing with the example code. If you would like to learn more please <a href="/projects/assembler-writeup.html">read my writeup here</a>.</p>
        <p>You can find all of the source code for my Assembler implementation on my GitHub here <a href="https://github.com/FrancisMcN/assembler" target="_blank">https://github.com/FrancisMcN/assembler</a></p>
        </div>
        <script src="../js/iframe-resizer/iframe-resizer.child.js"></script>
		<script type="text/javascript">

        function decodeCpuType(cpuType) {
                switch (cpuType) {
                    case 16777228:
                        return "CPU_TYPE_ARM64";
                    default:
                        return "UNKNOWN";
                }
            }

            function decodeCpuSubType(cpuSubType) {
                switch (cpuSubType) {
                    case 0:
                        return "CPU_SUBTYPE_ARM64_ALL";
                    default:
                        return "UNKNOWN";
                }
            }

            function decodeFileType(fileType) {
                switch (fileType) {
                    case 0:
                        return "MH_EXECUTE";
                    case 1:
                        return "MH_OBJECT";
                    default:
                        return "UNKNOWN";
                }
            }

            function toHexString(byteArray, byteclass) {
                let str = "";
                for (let i = 0; i < byteArray.length; i += 4) {
                    str += `<div class=\"byte\ ${byteclass}bytes" style="background-color: rgb(246 246 246);" onclick="showDetail('${byteclass}')">`;
                    for (let j = i; j < i + 4 && (j < byteArray.length); j++) {
                        str += ('0' + (byteArray[j] & 0xFF).toString(16)).slice(-2);
                    }
                    str += "</div>";
                }
                return str;
            }

            function decodeMachoJSON(json) {
                let result = document.getElementsByClassName("macho")[0];
                let loadCommandsSize = json.repr.header.loadCommandsSize;

                let sectionsSize = 0;
                let symbolsSize = 0;
                for (let command of json.repr.loadCommands) {
                    if (command.hasOwnProperty("name")) {
                        sectionsSize = command["vmSize"];
                    }
                    if (command.hasOwnProperty("numberOfSymbols")) {
                        symbolsSize = command["numberOfSymbols"] * 16;
                    }
                }

                let loadCommandsOffset = 32;
                let sectionsOffset = loadCommandsOffset + loadCommandsSize;
                let symbolsOffset = sectionsOffset + sectionsSize;
                let stringsOffset = symbolsOffset + symbolsSize;

                result.innerHTML = `
                    <h3>Assembler Output</h3>
                    <p>Below is the assembled Mach-O object file for your code above. You can click on any of the bytes from the assembled output below, each section will highlight and expand with more detail about the Mach-O object format.</p>
                    <div class="bytes">
                    ${toHexString(json.bytes.slice(0, 32), "header")}
                    <div id="headerdetail" class="sectionDetail">
                        <h3>The Mach-O Header</h3>
                        <p>The Macho-O header is 32 bytes in length. It specifies metadata about the object file such as whether it's 32 or 64 bit, whether it's an object file or an executable and its architecture such as x86 or ARM.</p>
                    </div>
                    ${toHexString(json.bytes.slice(loadCommandsOffset, sectionsOffset), "loadcommand")}
                    <div id="loadcommanddetail" class="sectionDetail">
                        <h3>Load Commands</h3>
                        <p>The load commands specify how data should be loaded into memory, they also specify some metadata such as the program entrypoint and the string table offset etc ...</p>
                    </div>
                    ${toHexString(json.bytes.slice(sectionsOffset, stringsOffset), "segment")}
                    <div id="segmentdetail" class="sectionDetail">
                        <h3>Sections</h3>
                        <p>Sections contain the actual data that's loaded into memory by dyld, MacOS's dynamic linker. The program's instructions are stored in this part of the object file.</p>
                    </div>
                    ${toHexString(json.bytes.slice(symbolsOffset, stringsOffset), "symboltable")}
                    <div id="symboltabledetail" class="sectionDetail">
                        <h3>Symbol Table</h3>
                        <p>The symbol table specifies the symbols contained within the object file and whether they're local or global. One important symbol in particular is _main which specifies the entrypoint for the program. Each symbol has a pointer into the string table.</p>
                    </div>
                    ${toHexString(json.bytes.slice(stringsOffset), "stringtable")}
                    <div id="stringtabledetail" class="sectionDetail">
                        <h3>String Table</h3>
                        <p>Every string present in the object file has an entry in the string table.</p>
                    </div>
                    </div>
                `;
                // result.innerHTML = `
                // <div class="machoHeader">
                //         <table>
                //             <tr>
                //                 <th>Description</th>
                //                 <th>Value</th>
                //             </tr>
                //             <tr>
                //                 <td>CPU Type</td>
                //                 <td>${decodeCpuType(json.repr.header.cpuType)}</td>
                //             </tr>
                //             <tr>
                //                 <td>CPU SubType</td>
                //                 <td>${decodeCpuSubType(json.repr.header.cpuSubType)}</td>
                //             </tr>
                //             <tr>
                //                 <td>File Type</td>
                //                 <td>${decodeFileType(json.repr.header.fileType)}</td>
                //             </tr>
                //             <tr>
                //                 <td>Load Command Count</td>
                //                 <td>${json.repr.header.loadCommandCount}</td>
                //             </tr>
                //         </table>
                //         ${json.repr.loadCommands.map(command => {
                //             return "<div><strong>"+ command.name +"</strong></div>";
                //         }).join("\n")}
                //         <p>Strings</p>
                //         ${json.repr.stringTable.strings.map(string => {
                //             return "<div>"+ string +"</div>";
                //         }).join("\n")}
                //     </div>
                //     `;
            }

            let enabledEventListeners = {
                headerbytes: true,
                loadcommandbytes: true,
                segmentbytes: true,
                stringtablebytes: true,
                symboltablebytes: true,
            }

            function enableEmbeddedEventListeners() {
                enabledEventListeners.headerbytes = true
                enabledEventListeners.loadcommandbytes = true
                enabledEventListeners.segmentbytes = true
                enabledEventListeners.stringtablebytes = true
                enabledEventListeners.symboltablebytes = true

            }

            function showDetail(detail) {
                let div = document.getElementById(`${detail}detail`);
                if (div.style.display == "" || div.style.display == "none") {
                    div.style.display = "block";
                    enabledEventListeners[`${detail}bytes`] = false;
                } else {
                    div.style.display = "none";
                    enabledEventListeners[`${detail}bytes`] = true;
                }
            }

            function expandBytes(event) {
                event.preventDefault();
                showDetail("header")
                showDetail("loadcommand")
                showDetail("segment")
                showDetail("stringtable")
                showDetail("symboltable")
                // toggleHighlightGroupOfBytes("headerbytes", true)()
                // toggleHighlightGroupOfBytes("loadcommandbytes", true)()
                // toggleHighlightGroupOfBytes("segmentbytes", true)()
                // toggleHighlightGroupOfBytes("stringtablebytes", true)()
                // toggleHighlightGroupOfBytes("symboltablebytes", true)()
            }

            function toggleHighlightGroupOfBytes(group, shouldHighlight) {
                // console.log("calling function")
                return function() {
                    let bytesSharingSameClass = document.getElementsByClassName(group);
                    if (enabledEventListeners[group]) {
                        for (let b of bytesSharingSameClass) {

                            if (shouldHighlight) {
                                b.style.backgroundColor = '';
                            } else {
                                b.style.backgroundColor = 'rgb(246 246 246)';
                            }
                        }
                    }
                }
            }

            function highlightBytes() {
                let bytes = document.getElementsByClassName("byte");
                for (let byte of bytes) {
                    byte.addEventListener("mouseover", toggleHighlightGroupOfBytes(byte.classList[1], true))
                    byte.addEventListener("mouseout", toggleHighlightGroupOfBytes(byte.classList[1], false))
                }
            }

            let playgrounds = document.getElementsByClassName("playground");
            for (let playground of playgrounds) {
                let form = playground.getElementsByTagName("form")[0];
                // Find submit button to run the code
                let button = form.getElementsByClassName("run")[0];
                // Find the loading image
                let loading = form.getElementsByClassName("loading")[0];
                // Find the run button for the playground
                let code = form.getElementsByClassName("code")[0];
                // Find the result div for the playground
                let result = playground.getElementsByClassName("macho")[0];
                code.onkeyup = function (event) {
                    code.rows = code.value.split("\n").length;
                }
                button.onclick = function(event) {
                    event.preventDefault();
                    button.disabled = true;
                    button.value = "";
                    loading.style.display = "block";
                    fetch(`https://playground.francismcnamee.com/run`, {
					method: "post",
					body: JSON.stringify({ type: "assembler", code: code.value}),
					headers: {
					    "Content-Type": "application/json",
  					},
				})
				.then(function(response) {
					if (!response.ok) {
						return Promise.reject(response)
					}
						return response.json();
				})
				.then(function(data) {
					result.style.display = "inline-block";
                    button.disabled = false;
                    button.value = "Run code";
                    loading.style.display = "none";
                    decodeMachoJSON(JSON.parse(data.msg));
                    highlightBytes();
					enableEmbeddedEventListeners();
				})
				.catch(function(error) {
                    console.log(error)
					return error.json()
						.then(function(error) {
                            button.disabled = false;
                            button.value = "Run code";
                            loading.style.display = "none";
							result.style.display = "inline-block";
                            enableEmbeddedEventListeners();
						})
				})
                };

            }
		</script>
    </body>
</html>